import { ChangeDetectorRef, DebugElement, ElementRef } from '@angular/core';
import { Observable } from 'rxjs';
import { tick } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { DOMSelector } from '../dom-selectors';
import { isString } from '../types';
import { getChildren, setProps } from '../internals/query';
import { patchElementFocus } from '../internals/element-focus';
import { createMouseEvent } from '../event-creators';
import { dispatchFakeEvent, dispatchKeyboardEvent, dispatchMouseEvent, dispatchTouchEvent } from '../dispatch-events';
import { typeInElement } from '../type-in-element';
import { selectOption } from '../select-option';
import { BaseSpectator } from './base-spectator';
const KEY_UP = 'keyup';
/**
 * @internal
 */
export class DomSpectator extends BaseSpectator {
    constructor(fixture, debugElement, instance, element) {
        super();
        this.fixture = fixture;
        this.debugElement = debugElement;
        this.instance = instance;
        this.element = element;
    }
    inject(token) {
        return super.inject(token);
    }
    detectChanges() {
        this.fixture.detectChanges();
    }
    query(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return document.querySelector(directiveOrSelector);
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document)[0] || null;
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options)[0] || null;
    }
    queryAll(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document);
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options);
    }
    queryLast(directiveOrSelector, options) {
        let result = [];
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                result = Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                result = directiveOrSelector.execute(document);
            }
        }
        else {
            result = getChildren(this.debugElement)(directiveOrSelector, options);
        }
        if (result && result.length) {
            return result[result.length - 1];
        }
        return null;
    }
    setInput(input, value) {
        setProps(this.instance, input, value, false);
        this.debugElement.injector.get(ChangeDetectorRef).detectChanges();
    }
    output(output) {
        const observable = this.instance[output];
        if (!(observable instanceof Observable)) {
            throw new Error(`${output} is not an @Output`);
        }
        return observable;
    }
    tick(millis) {
        tick(millis);
        this.detectChanges();
    }
    click(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot click: ${selector} is not a HTMLElement`);
        }
        element.click();
        this.detectChanges();
    }
    blur(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot blur: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.blur();
        this.detectChanges();
    }
    focus(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot focus: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.focus();
        this.detectChanges();
    }
    dispatchMouseEvent(selector = this.element, type, x = 0, y = 0, event = createMouseEvent(type, x, y)) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch mouse event: ${selector} is not a node`);
        }
        const dispatchedEvent = dispatchMouseEvent(element, type, x, y, event);
        this.detectChanges();
        return dispatchedEvent;
    }
    dispatchKeyboardEvent(selector = this.element, type, keyOrKeyCode, target) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch keyboard event: ${selector} is not a node`);
        }
        const event = dispatchKeyboardEvent(element, type, keyOrKeyCode, target);
        this.detectChanges();
        return event;
    }
    dispatchFakeEvent(selector = this.element, type, canBubble) {
        const event = dispatchFakeEvent(this.getNativeElement(selector), type, canBubble);
        this.detectChanges();
        return event;
    }
    triggerEventHandler(directiveOrSelector, eventName, eventObj) {
        const debugElement = this.getDebugElement(directiveOrSelector);
        if (!debugElement) {
            // tslint:disable:no-console
            console.error(`${directiveOrSelector} does not exists`);
            return;
        }
        debugElement.triggerEventHandler(eventName, eventObj);
        this.detectChanges();
    }
    get keyboard() {
        return {
            pressKey: (key, selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, key);
            },
            pressEscape: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Escape', keyCode: 27 });
            },
            pressEnter: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Enter', keyCode: 13 });
            },
            pressTab: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Tab', keyCode: 9 });
            },
            pressBackspace: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Backspace', keyCode: 8 });
            }
        };
    }
    get mouse() {
        return {
            contextmenu: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'contextmenu');
            },
            dblclick: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'dblclick');
            }
        };
    }
    dispatchTouchEvent(selector = this.element, type, x = 0, y = 0) {
        dispatchTouchEvent(this.getNativeElement(selector), type, x, y);
        this.detectChanges();
    }
    typeInElement(value, selector = this.element) {
        typeInElement(value, this.getNativeElement(selector));
        this.detectChanges();
    }
    selectOption(selector = this.element, options, config = { emitEvents: true }) {
        if (!selector) {
            throw new Error(`Cannot find select: ${selector}`);
        }
        selectOption(options, this.getNativeElement(selector), config);
        this.detectChanges();
    }
    getNativeElement(selector) {
        let element;
        // Support global objects window and document
        if (selector === window || selector === document) {
            return selector;
        }
        if (isString(selector)) {
            const exists = this.debugElement.query(By.css(selector));
            if (exists) {
                element = exists.nativeElement;
            }
            else {
                // tslint:disable:no-console
                console.error(`${selector} does not exists`);
            }
        }
        else if (selector instanceof DOMSelector) {
            element = selector.execute(document)[0] || null;
        }
        else {
            if (selector instanceof DebugElement || selector instanceof ElementRef) {
                element = selector.nativeElement;
            }
            else {
                element = selector;
            }
        }
        return element;
    }
    getDebugElement(directiveOrSelector) {
        let debugElement;
        if (isString(directiveOrSelector)) {
            debugElement = this.debugElement.query(By.css(directiveOrSelector));
        }
        else if (directiveOrSelector instanceof DebugElement) {
            debugElement = directiveOrSelector;
        }
        else {
            debugElement = this.debugElement.query(By.directive(directiveOrSelector));
        }
        return debugElement;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLXNwZWN0YXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NwZWN0YXRvci9zcmMvbGliL2Jhc2UvZG9tLXNwZWN0YXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDaEcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEVBQW9CLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUcvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFFBQVEsRUFBbUcsTUFBTSxVQUFVLENBQUM7QUFFckksT0FBTyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUscUJBQXFCLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0SCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWhELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFFdkI7O0dBRUc7QUFDSCxNQUFNLE9BQWdCLFlBQWdCLFNBQVEsYUFBYTtJQUN6RCxZQUFtQixPQUE4QixFQUFTLFlBQTBCLEVBQVksUUFBVyxF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QUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztTQUMzRTtRQUNELE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBEZWJ1Z0VsZW1lbnQsIEVsZW1lbnRSZWYsIFR5cGUsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ29tcG9uZW50Rml4dHVyZSwgdGljayB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBCeSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuXG5pbXBvcnQgeyBUb2tlbiB9IGZyb20gJy4uL3Rva2VuJztcbmltcG9ydCB7IERPTVNlbGVjdG9yIH0gZnJvbSAnLi4vZG9tLXNlbGVjdG9ycyc7XG5pbXBvcnQgeyBpc1N0cmluZywgUXVlcnlPcHRpb25zLCBRdWVyeVR5cGUsIFNwZWN0YXRvckVsZW1lbnQsIEV2ZW50RW1pdHRlclR5cGUsIEtleXNNYXRjaGluZywgS2V5Ym9hcmRFdmVudE9wdGlvbnMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBTcHlPYmplY3QgfSBmcm9tICcuLi9tb2NrJztcbmltcG9ydCB7IGdldENoaWxkcmVuLCBzZXRQcm9wcyB9IGZyb20gJy4uL2ludGVybmFscy9xdWVyeSc7XG5pbXBvcnQgeyBwYXRjaEVsZW1lbnRGb2N1cyB9IGZyb20gJy4uL2ludGVybmFscy9lbGVtZW50LWZvY3VzJztcbmltcG9ydCB7IGNyZWF0ZU1vdXNlRXZlbnQgfSBmcm9tICcuLi9ldmVudC1jcmVhdG9ycyc7XG5pbXBvcnQgeyBkaXNwYXRjaEZha2VFdmVudCwgZGlzcGF0Y2hLZXlib2FyZEV2ZW50LCBkaXNwYXRjaE1vdXNlRXZlbnQsIGRpc3BhdGNoVG91Y2hFdmVudCB9IGZyb20gJy4uL2Rpc3BhdGNoLWV2ZW50cyc7XG5pbXBvcnQgeyB0eXBlSW5FbGVtZW50IH0gZnJvbSAnLi4vdHlwZS1pbi1lbGVtZW50JztcbmltcG9ydCB7IHNlbGVjdE9wdGlvbiB9IGZyb20gJy4uL3NlbGVjdC1vcHRpb24nO1xuXG5pbXBvcnQgeyBCYXNlU3BlY3RhdG9yIH0gZnJvbSAnLi9iYXNlLXNwZWN0YXRvcic7XG5cbmNvbnN0IEtFWV9VUCA9ICdrZXl1cCc7XG5cbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBEb21TcGVjdGF0b3I8ST4gZXh0ZW5kcyBCYXNlU3BlY3RhdG9yIHtcbiAgY29uc3RydWN0b3IocHVibGljIGZpeHR1cmU6IENvbXBvbmVudEZpeHR1cmU8YW55PiwgcHVibGljIGRlYnVnRWxlbWVudDogRGVidWdFbGVtZW50LCBwcm90ZWN0ZWQgaW5zdGFuY2U6IEksIHB1YmxpYyBlbGVtZW50OiBFbGVtZW50KSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBpbmplY3Q8VD4odG9rZW46IFRva2VuPFQ+KTogU3B5T2JqZWN0PFQ+IHtcbiAgICByZXR1cm4gc3VwZXIuaW5qZWN0KHRva2VuKTtcbiAgfVxuXG4gIHB1YmxpYyBkZXRlY3RDaGFuZ2VzKCk6IHZvaWQge1xuICAgIHRoaXMuZml4dHVyZS5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgcXVlcnk8UiBleHRlbmRzIEVsZW1lbnQ+KHNlbGVjdG9yOiBzdHJpbmcgfCBET01TZWxlY3Rvciwgb3B0aW9ucz86IHsgcm9vdDogYm9vbGVhbiB9KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeTxSPihkaXJlY3RpdmU6IFR5cGU8Uj4pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5PFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFR5cGU8YW55PiB8IHN0cmluZywgb3B0aW9uczogeyByZWFkOiBUb2tlbjxSPiB9KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeTxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBRdWVyeVR5cGUsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnM8Uj4pOiBSIHwgRWxlbWVudCB8IG51bGwge1xuICAgIGlmICgob3B0aW9ucyB8fCB7fSkucm9vdCkge1xuICAgICAgaWYgKGlzU3RyaW5nKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKSB7XG4gICAgICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGRpcmVjdGl2ZU9yU2VsZWN0b3IpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERPTVNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiBkaXJlY3RpdmVPclNlbGVjdG9yLmV4ZWN1dGUoZG9jdW1lbnQgYXMgYW55KVswXSB8fCBudWxsO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBnZXRDaGlsZHJlbjxSPih0aGlzLmRlYnVnRWxlbWVudCkoZGlyZWN0aXZlT3JTZWxlY3Rvciwgb3B0aW9ucylbMF0gfHwgbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBxdWVyeUFsbDxSIGV4dGVuZHMgRWxlbWVudD4oc2VsZWN0b3I6IHN0cmluZyB8IERPTVNlbGVjdG9yLCBvcHRpb25zPzogeyByb290OiBib29sZWFuIH0pOiBSW107XG4gIHB1YmxpYyBxdWVyeUFsbDxSPihkaXJlY3RpdmU6IFR5cGU8Uj4pOiBSW107XG4gIHB1YmxpYyBxdWVyeUFsbDxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBUeXBlPGFueT4gfCBzdHJpbmcsIG9wdGlvbnM6IHsgcmVhZDogVG9rZW48Uj4gfSk6IFJbXTtcbiAgcHVibGljIHF1ZXJ5QWxsPFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFF1ZXJ5VHlwZSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9uczxSPik6IFJbXSB8IEVsZW1lbnRbXSB7XG4gICAgaWYgKChvcHRpb25zIHx8IHt9KS5yb290KSB7XG4gICAgICBpZiAoaXNTdHJpbmcoZGlyZWN0aXZlT3JTZWxlY3RvcikpIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChkaXJlY3RpdmVPclNlbGVjdG9yKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaXJlY3RpdmVPclNlbGVjdG9yIGluc3RhbmNlb2YgRE9NU2VsZWN0b3IpIHtcbiAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZU9yU2VsZWN0b3IuZXhlY3V0ZShkb2N1bWVudCBhcyBhbnkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBnZXRDaGlsZHJlbjxSPih0aGlzLmRlYnVnRWxlbWVudCkoZGlyZWN0aXZlT3JTZWxlY3Rvciwgb3B0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgcXVlcnlMYXN0PFIgZXh0ZW5kcyBFbGVtZW50PihzZWxlY3Rvcjogc3RyaW5nIHwgRE9NU2VsZWN0b3IsIG9wdGlvbnM/OiB7IHJvb3Q6IGJvb2xlYW4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnlMYXN0PFI+KGRpcmVjdGl2ZTogVHlwZTxSPik6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnlMYXN0PFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFR5cGU8YW55PiB8IHN0cmluZywgb3B0aW9uczogeyByZWFkOiBUb2tlbjxSPiB9KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeUxhc3Q8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogUXVlcnlUeXBlLCBvcHRpb25zPzogUXVlcnlPcHRpb25zPFI+KTogUiB8IEVsZW1lbnQgfCBudWxsIHtcbiAgICBsZXQgcmVzdWx0OiAoUiB8IEVsZW1lbnQpW10gPSBbXTtcblxuICAgIGlmICgob3B0aW9ucyB8fCB7fSkucm9vdCkge1xuICAgICAgaWYgKGlzU3RyaW5nKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKSB7XG4gICAgICAgIHJlc3VsdCA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChkaXJlY3RpdmVPclNlbGVjdG9yKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaXJlY3RpdmVPclNlbGVjdG9yIGluc3RhbmNlb2YgRE9NU2VsZWN0b3IpIHtcbiAgICAgICAgcmVzdWx0ID0gZGlyZWN0aXZlT3JTZWxlY3Rvci5leGVjdXRlKGRvY3VtZW50IGFzIGFueSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdCA9IGdldENoaWxkcmVuPFI+KHRoaXMuZGVidWdFbGVtZW50KShkaXJlY3RpdmVPclNlbGVjdG9yLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHtcbiAgICAgIHJldHVybiByZXN1bHRbcmVzdWx0Lmxlbmd0aCAtIDFdO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHVibGljIHNldElucHV0PEsgZXh0ZW5kcyBrZXlvZiBJPihpbnB1dDogUGFydGlhbDxJPik6IHZvaWQ7XG4gIHB1YmxpYyBzZXRJbnB1dDxLIGV4dGVuZHMga2V5b2YgST4oaW5wdXQ6IEssIGlucHV0VmFsdWU6IElbS10pOiB2b2lkO1xuICBwdWJsaWMgc2V0SW5wdXQoaW5wdXQ6IGFueSwgdmFsdWU/OiBhbnkpOiB2b2lkIHtcbiAgICBzZXRQcm9wcyh0aGlzLmluc3RhbmNlLCBpbnB1dCwgdmFsdWUsIGZhbHNlKTtcbiAgICB0aGlzLmRlYnVnRWxlbWVudC5pbmplY3Rvci5nZXQoQ2hhbmdlRGV0ZWN0b3JSZWYpLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBvdXRwdXQ8VCwgSyBleHRlbmRzIGtleW9mIEkgPSBrZXlvZiBJPihvdXRwdXQ6IEspOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gdGhpcy5pbnN0YW5jZVtvdXRwdXRdO1xuXG4gICAgaWYgKCEob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIE9ic2VydmFibGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7b3V0cHV0fSBpcyBub3QgYW4gQE91dHB1dGApO1xuICAgIH1cblxuICAgIHJldHVybiBvYnNlcnZhYmxlIGFzIE9ic2VydmFibGU8VD47XG4gIH1cblxuICBwdWJsaWMgdGljayhtaWxsaXM/OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aWNrKG1pbGxpcyk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgY2xpY2soc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKTtcblxuICAgIGlmICghKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNsaWNrOiAke3NlbGVjdG9yfSBpcyBub3QgYSBIVE1MRWxlbWVudGApO1xuICAgIH1cblxuICAgIGVsZW1lbnQuY2xpY2soKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBibHVyKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBibHVyOiAke3NlbGVjdG9yfSBpcyBub3QgYSBIVE1MRWxlbWVudGApO1xuICAgIH1cblxuICAgIHBhdGNoRWxlbWVudEZvY3VzKGVsZW1lbnQpO1xuICAgIGVsZW1lbnQuYmx1cigpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGZvY3VzKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmb2N1czogJHtzZWxlY3Rvcn0gaXMgbm90IGEgSFRNTEVsZW1lbnRgKTtcbiAgICB9XG5cbiAgICBwYXRjaEVsZW1lbnRGb2N1cyhlbGVtZW50KTtcbiAgICBlbGVtZW50LmZvY3VzKCk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgZGlzcGF0Y2hNb3VzZUV2ZW50KFxuICAgIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICB4OiBudW1iZXIgPSAwLFxuICAgIHk6IG51bWJlciA9IDAsXG4gICAgZXZlbnQ6IE1vdXNlRXZlbnQgPSBjcmVhdGVNb3VzZUV2ZW50KHR5cGUsIHgsIHkpXG4gICk6IE1vdXNlRXZlbnQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIE5vZGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBkaXNwYXRjaCBtb3VzZSBldmVudDogJHtzZWxlY3Rvcn0gaXMgbm90IGEgbm9kZWApO1xuICAgIH1cblxuICAgIGNvbnN0IGRpc3BhdGNoZWRFdmVudCA9IGRpc3BhdGNoTW91c2VFdmVudChlbGVtZW50LCB0eXBlLCB4LCB5LCBldmVudCk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICByZXR1cm4gZGlzcGF0Y2hlZEV2ZW50O1xuICB9XG5cbiAgcHVibGljIGRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCwgdHlwZTogc3RyaW5nLCBrZXlDb2RlOiBudW1iZXIsIHRhcmdldD86IEVsZW1lbnQpOiBLZXlib2FyZEV2ZW50O1xuICBwdWJsaWMgZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50LCB0eXBlOiBzdHJpbmcsIGtleTogc3RyaW5nLCB0YXJnZXQ/OiBFbGVtZW50KTogS2V5Ym9hcmRFdmVudDtcbiAgcHVibGljIGRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCwgdHlwZTogc3RyaW5nLCBrZXlBbmRDb2RlOiBLZXlib2FyZEV2ZW50T3B0aW9ucywgdGFyZ2V0PzogRWxlbWVudCk6IEtleWJvYXJkRXZlbnQ7XG4gIHB1YmxpYyBkaXNwYXRjaEtleWJvYXJkRXZlbnQoXG4gICAgc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsXG4gICAgdHlwZTogc3RyaW5nLFxuICAgIGtleU9yS2V5Q29kZTogc3RyaW5nIHwgbnVtYmVyIHwgS2V5Ym9hcmRFdmVudE9wdGlvbnMsXG4gICAgdGFyZ2V0PzogRWxlbWVudFxuICApOiBLZXlib2FyZEV2ZW50IHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKTtcblxuICAgIGlmICghKGVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZGlzcGF0Y2gga2V5Ym9hcmQgZXZlbnQ6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIG5vZGVgKTtcbiAgICB9XG5cbiAgICBjb25zdCBldmVudCA9IGRpc3BhdGNoS2V5Ym9hcmRFdmVudChlbGVtZW50LCB0eXBlLCBrZXlPcktleUNvZGUsIHRhcmdldCk7XG5cbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcblxuICAgIHJldHVybiBldmVudDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaEZha2VFdmVudChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgdHlwZTogc3RyaW5nLCBjYW5CdWJibGU/OiBib29sZWFuKTogRXZlbnQge1xuICAgIGNvbnN0IGV2ZW50ID0gZGlzcGF0Y2hGYWtlRXZlbnQodGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKSwgdHlwZSwgY2FuQnViYmxlKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcblxuICAgIHJldHVybiBldmVudDtcbiAgfVxuXG4gIHB1YmxpYyB0cmlnZ2VyRXZlbnRIYW5kbGVyPEMgPSBhbnksIEsgZXh0ZW5kcyBLZXlzTWF0Y2hpbmc8QywgRXZlbnRFbWl0dGVyPGFueT4+ID0gYW55PihcbiAgICBkaXJlY3RpdmVPclNlbGVjdG9yOiBUeXBlPEM+IHwgc3RyaW5nIHwgRGVidWdFbGVtZW50LFxuICAgIGV2ZW50TmFtZTogSyxcbiAgICBldmVudE9iajogRXZlbnRFbWl0dGVyVHlwZTxDW0tdPlxuICApIHtcbiAgICBjb25zdCBkZWJ1Z0VsZW1lbnQgPSB0aGlzLmdldERlYnVnRWxlbWVudChkaXJlY3RpdmVPclNlbGVjdG9yKTtcbiAgICBpZiAoIWRlYnVnRWxlbWVudCkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGU6bm8tY29uc29sZVxuICAgICAgY29uc29sZS5lcnJvcihgJHtkaXJlY3RpdmVPclNlbGVjdG9yfSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZGVidWdFbGVtZW50LnRyaWdnZXJFdmVudEhhbmRsZXIoZXZlbnROYW1lIGFzIHN0cmluZywgZXZlbnRPYmopO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGdldCBrZXlib2FyZCgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHJlc3NLZXk6IChrZXk6IHN0cmluZywgc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIGV2ZW50ID0gS0VZX1VQKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yLCBldmVudCwga2V5KTtcbiAgICAgIH0sXG4gICAgICBwcmVzc0VzY2FwZTogKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCBldmVudCA9IEtFWV9VUCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvciwgZXZlbnQsIHsga2V5OiAnRXNjYXBlJywga2V5Q29kZTogMjcgfSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NFbnRlcjogKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCBldmVudCA9IEtFWV9VUCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvciwgZXZlbnQsIHsga2V5OiAnRW50ZXInLCBrZXlDb2RlOiAxMyB9KTtcbiAgICAgIH0sXG4gICAgICBwcmVzc1RhYjogKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCBldmVudCA9IEtFWV9VUCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvciwgZXZlbnQsIHsga2V5OiAnVGFiJywga2V5Q29kZTogOSB9KTtcbiAgICAgIH0sXG4gICAgICBwcmVzc0JhY2tzcGFjZTogKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCBldmVudCA9IEtFWV9VUCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvciwgZXZlbnQsIHsga2V5OiAnQmFja3NwYWNlJywga2V5Q29kZTogOCB9KTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGdldCBtb3VzZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29udGV4dG1lbnU6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoTW91c2VFdmVudChzZWxlY3RvciwgJ2NvbnRleHRtZW51Jyk7XG4gICAgICB9LFxuICAgICAgZGJsY2xpY2s6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoTW91c2VFdmVudChzZWxlY3RvciwgJ2RibGNsaWNrJyk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaFRvdWNoRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIHR5cGU6IHN0cmluZywgeDogbnVtYmVyID0gMCwgeTogbnVtYmVyID0gMCk6IHZvaWQge1xuICAgIGRpc3BhdGNoVG91Y2hFdmVudCh0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpLCB0eXBlLCB4LCB5KTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyB0eXBlSW5FbGVtZW50KHZhbHVlOiBzdHJpbmcsIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KTogdm9pZCB7XG4gICAgdHlwZUluRWxlbWVudCh2YWx1ZSwgdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgc2VsZWN0T3B0aW9uKFxuICAgIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgIG9wdGlvbnM6IHN0cmluZyB8IHN0cmluZ1tdIHwgSFRNTE9wdGlvbkVsZW1lbnQgfCBIVE1MT3B0aW9uRWxlbWVudFtdLFxuICAgIGNvbmZpZzogeyBlbWl0RXZlbnRzOiBib29sZWFuIH0gPSB7IGVtaXRFdmVudHM6IHRydWUgfVxuICApOiB2b2lkIHtcbiAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIHNlbGVjdDogJHtzZWxlY3Rvcn1gKTtcbiAgICB9XG4gICAgc2VsZWN0T3B0aW9uKG9wdGlvbnMsIHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3RvciksIGNvbmZpZyk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIGdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQpOiBIVE1MRWxlbWVudCB8IFdpbmRvdyB8IERvY3VtZW50IHtcbiAgICBsZXQgZWxlbWVudDtcblxuICAgIC8vIFN1cHBvcnQgZ2xvYmFsIG9iamVjdHMgd2luZG93IGFuZCBkb2N1bWVudFxuICAgIGlmIChzZWxlY3RvciA9PT0gd2luZG93IHx8IHNlbGVjdG9yID09PSBkb2N1bWVudCkge1xuICAgICAgcmV0dXJuIHNlbGVjdG9yO1xuICAgIH1cblxuICAgIGlmIChpc1N0cmluZyhzZWxlY3RvcikpIHtcbiAgICAgIGNvbnN0IGV4aXN0cyA9IHRoaXMuZGVidWdFbGVtZW50LnF1ZXJ5KEJ5LmNzcyhzZWxlY3RvcikpO1xuICAgICAgaWYgKGV4aXN0cykge1xuICAgICAgICBlbGVtZW50ID0gZXhpc3RzLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZTpuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYCR7c2VsZWN0b3J9IGRvZXMgbm90IGV4aXN0c2ApO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc2VsZWN0b3IgaW5zdGFuY2VvZiBET01TZWxlY3Rvcikge1xuICAgICAgZWxlbWVudCA9IHNlbGVjdG9yLmV4ZWN1dGUoZG9jdW1lbnQgYXMgYW55KVswXSB8fCBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoc2VsZWN0b3IgaW5zdGFuY2VvZiBEZWJ1Z0VsZW1lbnQgfHwgc2VsZWN0b3IgaW5zdGFuY2VvZiBFbGVtZW50UmVmKSB7XG4gICAgICAgIGVsZW1lbnQgPSBzZWxlY3Rvci5uYXRpdmVFbGVtZW50O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZWxlbWVudCA9IHNlbGVjdG9yO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlbGVtZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZWJ1Z0VsZW1lbnQoZGlyZWN0aXZlT3JTZWxlY3Rvcjogc3RyaW5nIHwgRGVidWdFbGVtZW50IHwgVHlwZTx1bmtub3duPikge1xuICAgIGxldCBkZWJ1Z0VsZW1lbnQ6IERlYnVnRWxlbWVudDtcbiAgICBpZiAoaXNTdHJpbmcoZGlyZWN0aXZlT3JTZWxlY3RvcikpIHtcbiAgICAgIGRlYnVnRWxlbWVudCA9IHRoaXMuZGVidWdFbGVtZW50LnF1ZXJ5KEJ5LmNzcyhkaXJlY3RpdmVPclNlbGVjdG9yKSk7XG4gICAgfSBlbHNlIGlmIChkaXJlY3RpdmVPclNlbGVjdG9yIGluc3RhbmNlb2YgRGVidWdFbGVtZW50KSB7XG4gICAgICBkZWJ1Z0VsZW1lbnQgPSBkaXJlY3RpdmVPclNlbGVjdG9yO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWJ1Z0VsZW1lbnQgPSB0aGlzLmRlYnVnRWxlbWVudC5xdWVyeShCeS5kaXJlY3RpdmUoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgIH1cbiAgICByZXR1cm4gZGVidWdFbGVtZW50O1xuICB9XG59XG4iXX0=