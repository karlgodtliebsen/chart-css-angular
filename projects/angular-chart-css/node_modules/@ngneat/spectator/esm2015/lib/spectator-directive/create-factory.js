import { TestBed, waitForAsync } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { BrowserDynamicTestingModule } from '@angular/platform-browser-dynamic/testing';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { addMatchers } from '../core';
import { isType } from '../types';
import { nodeByDirective } from '../internals/node-by-directive';
import { initialSpectatorDirectiveModule } from './initial-module';
import { getSpectatorDirectiveDefaultOptions } from './options';
import { SpectatorDirective } from './spectator-directive';
import { overrideModules } from '../spectator/create-factory';
export function createDirectiveFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getSpectatorDirectiveDefaultOptions({ directive: typeOrOptions })
        : getSpectatorDirectiveDefaultOptions(typeOrOptions);
    const moduleMetadata = initialSpectatorDirectiveModule(options);
    beforeEach(waitForAsync(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
    }));
    return (template, overrides) => {
        const defaults = {
            props: {},
            hostProps: {},
            detectChanges: true,
            providers: []
        };
        const { detectChanges, props, hostProps, providers } = Object.assign(Object.assign({}, defaults), overrides);
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        TestBed.overrideModule(BrowserDynamicTestingModule, {
            set: {
                entryComponents: moduleMetadata.entryComponents
            }
        }).overrideComponent(options.host, {
            set: { template: template || options.template }
        });
        if (options.directiveProviders.length || options.directiveMocks.length) {
            TestBed.overrideDirective(options.directive, {
                set: { providers: [...options.directiveProviders, ...options.directiveMocks.map(p => options.mockProvider(p))] }
            });
        }
        const spectator = createSpectatorDirective(options, props, hostProps);
        if (options.detectChanges && detectChanges) {
            spectator.detectChanges();
        }
        return spectator;
    };
}
function createSpectatorDirective(options, props, hostProps) {
    const hostFixture = TestBed.createComponent(options.host);
    const debugElement = hostFixture.debugElement.query(By.directive(options.directive)) || hostFixture.debugElement;
    const debugNode = hostFixture.debugElement.queryAllNodes(nodeByDirective(options.directive))[0];
    if (!debugNode) {
        throw new Error(`Cannot find directive ${options.directive} in host template ðŸ˜”`);
    }
    const hostComponent = setProps(hostFixture.componentInstance, hostProps);
    const directive = setProps(debugNode.injector.get(options.directive), props);
    return new SpectatorDirective(hostComponent, hostFixture, hostFixture.debugElement, directive, debugElement.nativeElement);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zcGVjdGF0b3Ivc3JjL2xpYi9zcGVjdGF0b3ItZGlyZWN0aXZlL2NyZWF0ZS1mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDOUQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQy9DLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBRXhGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssY0FBYyxNQUFNLGFBQWEsQ0FBQztBQUM5QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFHbEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRWpFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxtQ0FBbUMsRUFBNkIsTUFBTSxXQUFXLENBQUM7QUFDM0YsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBd0M5RCxNQUFNLFVBQVUsc0JBQXNCLENBQ3BDLGFBQXdEO0lBRXhELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7UUFDbkMsQ0FBQyxDQUFDLG1DQUFtQyxDQUFPLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxDQUFDO1FBQ3pFLENBQUMsQ0FBQyxtQ0FBbUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUV2RCxNQUFNLGNBQWMsR0FBRywrQkFBK0Is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QkFBaUIsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN6RSxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRTdFLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxhQUFhLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxZQUFZLEVBQUUsU0FBUyxFQUFFLFlBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUM3SCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvdmlkZXIsIFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRlc3RCZWQsIHdhaXRGb3JBc3luYyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBCeSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgQnJvd3NlckR5bmFtaWNUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci1keW5hbWljL3Rlc3RpbmcnO1xuXG5pbXBvcnQgeyBzZXRQcm9wcyB9IGZyb20gJy4uL2ludGVybmFscy9xdWVyeSc7XG5pbXBvcnQgKiBhcyBjdXN0b21NYXRjaGVycyBmcm9tICcuLi9tYXRjaGVycyc7XG5pbXBvcnQgeyBhZGRNYXRjaGVycyB9IGZyb20gJy4uL2NvcmUnO1xuaW1wb3J0IHsgaXNUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgSG9zdENvbXBvbmVudCB9IGZyb20gJy4uL3NwZWN0YXRvci1ob3N0L2hvc3QtY29tcG9uZW50JztcbmltcG9ydCB7IEJhc2VTcGVjdGF0b3JPdmVycmlkZXMgfSBmcm9tICcuLi9iYXNlL29wdGlvbnMnO1xuaW1wb3J0IHsgbm9kZUJ5RGlyZWN0aXZlIH0gZnJvbSAnLi4vaW50ZXJuYWxzL25vZGUtYnktZGlyZWN0aXZlJztcblxuaW1wb3J0IHsgaW5pdGlhbFNwZWN0YXRvckRpcmVjdGl2ZU1vZHVsZSB9IGZyb20gJy4vaW5pdGlhbC1tb2R1bGUnO1xuaW1wb3J0IHsgZ2V0U3BlY3RhdG9yRGlyZWN0aXZlRGVmYXVsdE9wdGlvbnMsIFNwZWN0YXRvckRpcmVjdGl2ZU9wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMnO1xuaW1wb3J0IHsgU3BlY3RhdG9yRGlyZWN0aXZlIH0gZnJvbSAnLi9zcGVjdGF0b3ItZGlyZWN0aXZlJztcbmltcG9ydCB7IG92ZXJyaWRlTW9kdWxlcyB9IGZyb20gJy4uL3NwZWN0YXRvci9jcmVhdGUtZmFjdG9yeSc7XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgdHlwZSBTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+ID0gPEhQPihcbiAgdGVtcGxhdGU6IHN0cmluZyxcbiAgb3ZlcnJpZGVzPzogU3BlY3RhdG9yRGlyZWN0aXZlT3ZlcnJpZGVzPEQsIEgsIEhQPlxuKSA9PiBTcGVjdGF0b3JEaXJlY3RpdmU8RCwgSCAmIChIb3N0Q29tcG9uZW50IGV4dGVuZHMgSCA/IEhQIDogdW5rbm93bik+O1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IHR5cGUgUHJlc2V0U3BlY3RhdG9yRGlyZWN0aXZlRmFjdG9yeTxELCBIPiA9IDxIUD4oXG4gIHRlbXBsYXRlPzogc3RyaW5nLFxuICBvdmVycmlkZXM/OiBTcGVjdGF0b3JEaXJlY3RpdmVPdmVycmlkZXM8RCwgSCwgSFA+XG4pID0+IFNwZWN0YXRvckRpcmVjdGl2ZTxELCBIICYgKEhvc3RDb21wb25lbnQgZXh0ZW5kcyBIID8gSFAgOiB1bmtub3duKT47XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFNwZWN0YXRvckRpcmVjdGl2ZU92ZXJyaWRlczxELCBILCBIUD4gZXh0ZW5kcyBCYXNlU3BlY3RhdG9yT3ZlcnJpZGVzIHtcbiAgZGV0ZWN0Q2hhbmdlcz86IGJvb2xlYW47XG4gIHByb3BzPzogUGFydGlhbDxEPjtcbiAgaG9zdFByb3BzPzogSG9zdENvbXBvbmVudCBleHRlbmRzIEggPyBIUCA6IFBhcnRpYWw8SD47XG4gIGRpcmVjdGl2ZVByb3ZpZGVycz86IFByb3ZpZGVyW107XG59XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRGlyZWN0aXZlRmFjdG9yeTxELCBIID0gSG9zdENvbXBvbmVudD4oXG4gIG9wdGlvbnM6IFNwZWN0YXRvckRpcmVjdGl2ZU9wdGlvbnM8RCwgSD4gJiB7IHRlbXBsYXRlOiBzdHJpbmcgfVxuKTogUHJlc2V0U3BlY3RhdG9yRGlyZWN0aXZlRmFjdG9yeTxELCBIPjtcbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRGlyZWN0aXZlRmFjdG9yeTxELCBIID0gSG9zdENvbXBvbmVudD4oXG4gIHR5cGVPck9wdGlvbnM6IFR5cGU8RD4gfCBTcGVjdGF0b3JEaXJlY3RpdmVPcHRpb25zPEQsIEg+XG4pOiBTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+O1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZURpcmVjdGl2ZUZhY3Rvcnk8RCwgSCA9IEhvc3RDb21wb25lbnQ+KFxuICB0eXBlT3JPcHRpb25zOiBUeXBlPEQ+IHwgU3BlY3RhdG9yRGlyZWN0aXZlT3B0aW9uczxELCBIPlxuKTogU3BlY3RhdG9yRGlyZWN0aXZlRmFjdG9yeTxELCBIPiB7XG4gIGNvbnN0IG9wdGlvbnMgPSBpc1R5cGUodHlwZU9yT3B0aW9ucylcbiAgICA/IGdldFNwZWN0YXRvckRpcmVjdGl2ZURlZmF1bHRPcHRpb25zPEQsIEg+KHsgZGlyZWN0aXZlOiB0eXBlT3JPcHRpb25zIH0pXG4gICAgOiBnZXRTcGVjdGF0b3JEaXJlY3RpdmVEZWZhdWx0T3B0aW9ucyh0eXBlT3JPcHRpb25zKTtcblxuICBjb25zdCBtb2R1bGVNZXRhZGF0YSA9IGluaXRpYWxTcGVjdGF0b3JEaXJlY3RpdmVNb2R1bGU8RCwgSD4ob3B0aW9ucyk7XG5cbiAgYmVmb3JlRWFjaChcbiAgICB3YWl0Rm9yQXN5bmMoKCkgPT4ge1xuICAgICAgYWRkTWF0Y2hlcnMoY3VzdG9tTWF0Y2hlcnMpO1xuICAgICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKG1vZHVsZU1ldGFkYXRhKTtcbiAgICAgIG92ZXJyaWRlTW9kdWxlcyhvcHRpb25zKTtcbiAgICB9KVxuICApO1xuXG4gIHJldHVybiA8SFA+KHRlbXBsYXRlPzogc3RyaW5nLCBvdmVycmlkZXM/OiBTcGVjdGF0b3JEaXJlY3RpdmVPdmVycmlkZXM8RCwgSCwgSFA+KSA9PiB7XG4gICAgY29uc3QgZGVmYXVsdHM6IFNwZWN0YXRvckRpcmVjdGl2ZU92ZXJyaWRlczxELCBILCBIUD4gPSB7XG4gICAgICBwcm9wczoge30sXG4gICAgICBob3N0UHJvcHM6IHt9IGFzIGFueSxcbiAgICAgIGRldGVjdENoYW5nZXM6IHRydWUsXG4gICAgICBwcm92aWRlcnM6IFtdXG4gICAgfTtcbiAgICBjb25zdCB7IGRldGVjdENoYW5nZXMsIHByb3BzLCBob3N0UHJvcHMsIHByb3ZpZGVycyB9ID0geyAuLi5kZWZhdWx0cywgLi4ub3ZlcnJpZGVzIH07XG5cbiAgICBpZiAocHJvdmlkZXJzICYmIHByb3ZpZGVycy5sZW5ndGgpIHtcbiAgICAgIHByb3ZpZGVycy5mb3JFYWNoKChwcm92aWRlcjogUHJvdmlkZXIpID0+IHtcbiAgICAgICAgVGVzdEJlZC5vdmVycmlkZVByb3ZpZGVyKChwcm92aWRlciBhcyBhbnkpLnByb3ZpZGUsIHByb3ZpZGVyIGFzIGFueSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBUZXN0QmVkLm92ZXJyaWRlTW9kdWxlKEJyb3dzZXJEeW5hbWljVGVzdGluZ01vZHVsZSwge1xuICAgICAgc2V0OiB7XG4gICAgICAgIGVudHJ5Q29tcG9uZW50czogbW9kdWxlTWV0YWRhdGEuZW50cnlDb21wb25lbnRzXG4gICAgICB9XG4gICAgfSkub3ZlcnJpZGVDb21wb25lbnQob3B0aW9ucy5ob3N0LCB7XG4gICAgICBzZXQ6IHsgdGVtcGxhdGU6IHRlbXBsYXRlIHx8IG9wdGlvbnMudGVtcGxhdGUgfVxuICAgIH0pO1xuXG4gICAgaWYgKG9wdGlvbnMuZGlyZWN0aXZlUHJvdmlkZXJzLmxlbmd0aCB8fCBvcHRpb25zLmRpcmVjdGl2ZU1vY2tzLmxlbmd0aCkge1xuICAgICAgVGVzdEJlZC5vdmVycmlkZURpcmVjdGl2ZShvcHRpb25zLmRpcmVjdGl2ZSwge1xuICAgICAgICBzZXQ6IHsgcHJvdmlkZXJzOiBbLi4ub3B0aW9ucy5kaXJlY3RpdmVQcm92aWRlcnMsIC4uLm9wdGlvbnMuZGlyZWN0aXZlTW9ja3MubWFwKHAgPT4gb3B0aW9ucy5tb2NrUHJvdmlkZXIocCkpXSB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzcGVjdGF0b3IgPSBjcmVhdGVTcGVjdGF0b3JEaXJlY3RpdmUob3B0aW9ucywgcHJvcHMsIGhvc3RQcm9wcyk7XG5cbiAgICBpZiAob3B0aW9ucy5kZXRlY3RDaGFuZ2VzICYmIGRldGVjdENoYW5nZXMpIHtcbiAgICAgIHNwZWN0YXRvci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNwZWN0YXRvcjtcbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU3BlY3RhdG9yRGlyZWN0aXZlPEQsIEgsIEhQPihcbiAgb3B0aW9uczogUmVxdWlyZWQ8U3BlY3RhdG9yRGlyZWN0aXZlT3B0aW9uczxELCBIPj4sXG4gIHByb3BzPzogUGFydGlhbDxEPixcbiAgaG9zdFByb3BzPzogSFBcbik6IFNwZWN0YXRvckRpcmVjdGl2ZTxELCBIICYgSFA+IHtcbiAgY29uc3QgaG9zdEZpeHR1cmUgPSBUZXN0QmVkLmNyZWF0ZUNvbXBvbmVudChvcHRpb25zLmhvc3QpO1xuICBjb25zdCBkZWJ1Z0VsZW1lbnQgPSBob3N0Rml4dHVyZS5kZWJ1Z0VsZW1lbnQucXVlcnkoQnkuZGlyZWN0aXZlKG9wdGlvbnMuZGlyZWN0aXZlKSkgfHwgaG9zdEZpeHR1cmUuZGVidWdFbGVtZW50O1xuICBjb25zdCBkZWJ1Z05vZGUgPSBob3N0Rml4dHVyZS5kZWJ1Z0VsZW1lbnQucXVlcnlBbGxOb2Rlcyhub2RlQnlEaXJlY3RpdmUob3B0aW9ucy5kaXJlY3RpdmUpKVswXTtcblxuICBpZiAoIWRlYnVnTm9kZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbmQgZGlyZWN0aXZlICR7b3B0aW9ucy5kaXJlY3RpdmV9IGluIGhvc3QgdGVtcGxhdGUg8J+YlGApO1xuICB9XG5cbiAgY29uc3QgaG9zdENvbXBvbmVudCA9IHNldFByb3BzKGhvc3RGaXh0dXJlLmNvbXBvbmVudEluc3RhbmNlLCBob3N0UHJvcHMpO1xuICBjb25zdCBkaXJlY3RpdmUgPSBzZXRQcm9wcyhkZWJ1Z05vZGUuaW5qZWN0b3IuZ2V0KG9wdGlvbnMuZGlyZWN0aXZlKSwgcHJvcHMpO1xuXG4gIHJldHVybiBuZXcgU3BlY3RhdG9yRGlyZWN0aXZlKGhvc3RDb21wb25lbnQsIGhvc3RGaXh0dXJlLCBob3N0Rml4dHVyZS5kZWJ1Z0VsZW1lbnQsIGRpcmVjdGl2ZSwgZGVidWdFbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xufVxuIl19