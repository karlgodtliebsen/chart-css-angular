import { NgZone } from '@angular/core';
import { TestBed, waitForAsync } from '@angular/core/testing';
import { ActivatedRoute, Router } from '@angular/router';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { overrideComponentIfProviderOverridesSpecified, overrideModules } from '../spectator/create-factory';
import { addMatchers } from '../core';
import { isType } from '../types';
import { ActivatedRouteStub } from './activated-route-stub';
import { initialRoutingModule } from './initial-module';
import { getRoutingDefaultOptions } from './options';
import { SpectatorRouting } from './spectator-routing';
/**
 * @publicApi
 */
export function createRoutingFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getRoutingDefaultOptions({ component: typeOrOptions })
        : getRoutingDefaultOptions(typeOrOptions);
    const moduleMetadata = initialRoutingModule(options);
    beforeEach(waitForAsync(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
        overrideComponentIfProviderOverridesSpecified(options);
        TestBed.compileComponents();
    }));
    return (overrides) => {
        const defaults = {
            props: {},
            detectChanges: true,
            providers: []
        };
        const { detectChanges, props, providers } = Object.assign(Object.assign({}, defaults), overrides);
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        const { params, queryParams, data, fragment, url, root, parent, children, firstChild } = Object.assign(Object.assign({}, options), overrides);
        TestBed.overrideProvider(ActivatedRoute, {
            useValue: new ActivatedRouteStub({ params, queryParams, data, fragment, url, root, parent, children, firstChild })
        });
        const ngZone = TestBed.inject ? TestBed.inject(NgZone) : TestBed.get(NgZone);
        return ngZone.run(() => {
            const spectator = createSpectatorRouting(options, props);
            spectator.router.initialNavigation();
            if (options.detectChanges && detectChanges) {
                spectator.detectChanges();
            }
            return spectator;
        });
    };
}
function createSpectatorRouting(options, props) {
    const fixture = TestBed.createComponent(options.component);
    const debugElement = fixture.debugElement;
    const component = setProps(fixture.componentInstance, props);
    /**
     * Back compatibility, angular under 9 version doesnt have a inject function
     */
    if (!TestBed.inject) {
        return new SpectatorRouting(fixture, debugElement, component, TestBed.get(Router), TestBed.get(ActivatedRoute));
    }
    return new SpectatorRouting(fixture, debugElement, component, TestBed.inject(Router), TestBed.inject(ActivatedRoute));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zcGVjdGF0b3Ivc3JjL2xpYi9zcGVjdGF0b3Itcm91dGluZy9jcmVhdGUtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWtCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFekQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sS0FBSyxjQUFjLE1BQU0sYUFBYSxDQUFDO0FBQzlDLE9BQU8sRUFBc0IsNkNBQTZDLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDakksT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSx3QkFBd0IsRUFBMkIsTUFBTSxXQUFXLENBQUM7QUFFOUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFhdkQ7O0dBRUc7QUFDSCxNQUFNLFVBQVUsb0JBQW9CLENBQUksYUFBbUQ7SUFDekYsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQztRQUNuQyxDQUFDLENBQUMsd0JBQXdCLENBQUksRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLENBQUM7UUFDM0QsQ0FBQyxDQUFDLHdCQUF3QixDQUFDLGFBQWEsQ0FBQyxDQUFD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SDtJQUVELE9BQU8sSUFBSSxnQkFBZ0IsQ0FDekIsT0FBTyxFQUNQLFlBQVksRUFDWixTQUFTLEVBQ1QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFDdEIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQWtDLENBQ2hFLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvdmlkZXIsIFR5cGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGVzdEJlZCwgd2FpdEZvckFzeW5jIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBzZXRQcm9wcyB9IGZyb20gJy4uL2ludGVybmFscy9xdWVyeSc7XG5pbXBvcnQgKiBhcyBjdXN0b21NYXRjaGVycyBmcm9tICcuLi9tYXRjaGVycyc7XG5pbXBvcnQgeyBTcGVjdGF0b3JPdmVycmlkZXMsIG92ZXJyaWRlQ29tcG9uZW50SWZQcm92aWRlck92ZXJyaWRlc1NwZWNpZmllZCwgb3ZlcnJpZGVNb2R1bGVzIH0gZnJvbSAnLi4vc3BlY3RhdG9yL2NyZWF0ZS1mYWN0b3J5JztcbmltcG9ydCB7IGFkZE1hdGNoZXJzIH0gZnJvbSAnLi4vY29yZSc7XG5pbXBvcnQgeyBpc1R5cGUgfSBmcm9tICcuLi90eXBlcyc7XG5cbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU3R1YiB9IGZyb20gJy4vYWN0aXZhdGVkLXJvdXRlLXN0dWInO1xuaW1wb3J0IHsgaW5pdGlhbFJvdXRpbmdNb2R1bGUgfSBmcm9tICcuL2luaXRpYWwtbW9kdWxlJztcbmltcG9ydCB7IGdldFJvdXRpbmdEZWZhdWx0T3B0aW9ucywgU3BlY3RhdG9yUm91dGluZ09wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMnO1xuaW1wb3J0IHsgUm91dGVPcHRpb25zIH0gZnJvbSAnLi9yb3V0ZS1vcHRpb25zJztcbmltcG9ydCB7IFNwZWN0YXRvclJvdXRpbmcgfSBmcm9tICcuL3NwZWN0YXRvci1yb3V0aW5nJztcbmltcG9ydCB7IFNweU9iamVjdCB9IGZyb20gJy4uL21vY2snO1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IHR5cGUgU3BlY3RhdG9yUm91dGluZ092ZXJyaWRlczxDPiA9IFNwZWN0YXRvck92ZXJyaWRlczxDPiAmIFJvdXRlT3B0aW9ucztcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCB0eXBlIFNwZWN0YXRvclJvdXRpbmdGYWN0b3J5PEM+ID0gKG9wdGlvbnM/OiBTcGVjdGF0b3JSb3V0aW5nT3ZlcnJpZGVzPEM+KSA9PiBTcGVjdGF0b3JSb3V0aW5nPEM+O1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJvdXRpbmdGYWN0b3J5PEM+KHR5cGVPck9wdGlvbnM6IFR5cGU8Qz4gfCBTcGVjdGF0b3JSb3V0aW5nT3B0aW9uczxDPik6IFNwZWN0YXRvclJvdXRpbmdGYWN0b3J5PEM+IHtcbiAgY29uc3Qgb3B0aW9ucyA9IGlzVHlwZSh0eXBlT3JPcHRpb25zKVxuICAgID8gZ2V0Um91dGluZ0RlZmF1bHRPcHRpb25zPEM+KHsgY29tcG9uZW50OiB0eXBlT3JPcHRpb25zIH0pXG4gICAgOiBnZXRSb3V0aW5nRGVmYXVsdE9wdGlvbnModHlwZU9yT3B0aW9ucyk7XG5cbiAgY29uc3QgbW9kdWxlTWV0YWRhdGEgPSBpbml0aWFsUm91dGluZ01vZHVsZTxDPihvcHRpb25zKTtcblxuICBiZWZvcmVFYWNoKFxuICAgIHdhaXRGb3JBc3luYygoKSA9PiB7XG4gICAgICBhZGRNYXRjaGVycyhjdXN0b21NYXRjaGVycyk7XG4gICAgICBUZXN0QmVkLmNvbmZpZ3VyZVRlc3RpbmdNb2R1bGUobW9kdWxlTWV0YWRhdGEpO1xuXG4gICAgICBvdmVycmlkZU1vZHVsZXMob3B0aW9ucyk7XG5cbiAgICAgIG92ZXJyaWRlQ29tcG9uZW50SWZQcm92aWRlck92ZXJyaWRlc1NwZWNpZmllZChvcHRpb25zKTtcblxuICAgICAgVGVzdEJlZC5jb21waWxlQ29tcG9uZW50cygpO1xuICAgIH0pXG4gICk7XG5cbiAgcmV0dXJuIChvdmVycmlkZXM/OiBTcGVjdGF0b3JSb3V0aW5nT3ZlcnJpZGVzPEM+KSA9PiB7XG4gICAgY29uc3QgZGVmYXVsdHM6IFNwZWN0YXRvclJvdXRpbmdPdmVycmlkZXM8Qz4gPSB7XG4gICAgICBwcm9wczoge30sXG4gICAgICBkZXRlY3RDaGFuZ2VzOiB0cnVlLFxuICAgICAgcHJvdmlkZXJzOiBbXVxuICAgIH07XG5cbiAgICBjb25zdCB7IGRldGVjdENoYW5nZXMsIHByb3BzLCBwcm92aWRlcnMgfSA9IHsgLi4uZGVmYXVsdHMsIC4uLm92ZXJyaWRlcyB9O1xuXG4gICAgaWYgKHByb3ZpZGVycyAmJiBwcm92aWRlcnMubGVuZ3RoKSB7XG4gICAgICBwcm92aWRlcnMuZm9yRWFjaCgocHJvdmlkZXI6IFByb3ZpZGVyKSA9PiB7XG4gICAgICAgIFRlc3RCZWQub3ZlcnJpZGVQcm92aWRlcigocHJvdmlkZXIgYXMgYW55KS5wcm92aWRlLCBwcm92aWRlciBhcyBhbnkpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBwYXJhbXMsIHF1ZXJ5UGFyYW1zLCBkYXRhLCBmcmFnbWVudCwgdXJsLCByb290LCBwYXJlbnQsIGNoaWxkcmVuLCBmaXJzdENoaWxkIH0gPSB7IC4uLm9wdGlvbnMsIC4uLm92ZXJyaWRlcyB9O1xuXG4gICAgVGVzdEJlZC5vdmVycmlkZVByb3ZpZGVyKEFjdGl2YXRlZFJvdXRlLCB7XG4gICAgICB1c2VWYWx1ZTogbmV3IEFjdGl2YXRlZFJvdXRlU3R1Yih7IHBhcmFtcywgcXVlcnlQYXJhbXMsIGRhdGEsIGZyYWdtZW50LCB1cmwsIHJvb3QsIHBhcmVudCwgY2hpbGRyZW4sIGZpcnN0Q2hpbGQgfSlcbiAgICB9KTtcbiAgICBjb25zdCBuZ1pvbmUgPSAoPGFueT5UZXN0QmVkKS5pbmplY3QgPyBUZXN0QmVkLmluamVjdChOZ1pvbmUpIDogVGVzdEJlZC5nZXQoTmdab25lKTtcblxuICAgIHJldHVybiBuZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgIGNvbnN0IHNwZWN0YXRvciA9IGNyZWF0ZVNwZWN0YXRvclJvdXRpbmcob3B0aW9ucywgcHJvcHMpO1xuXG4gICAgICBzcGVjdGF0b3Iucm91dGVyLmluaXRpYWxOYXZpZ2F0aW9uKCk7XG5cbiAgICAgIGlmIChvcHRpb25zLmRldGVjdENoYW5nZXMgJiYgZGV0ZWN0Q2hhbmdlcykge1xuICAgICAgICBzcGVjdGF0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gc3BlY3RhdG9yO1xuICAgIH0pO1xuICB9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTcGVjdGF0b3JSb3V0aW5nPEM+KG9wdGlvbnM6IFJlcXVpcmVkPFNwZWN0YXRvclJvdXRpbmdPcHRpb25zPEM+PiwgcHJvcHM/OiBQYXJ0aWFsPEM+KTogU3BlY3RhdG9yUm91dGluZzxDPiB7XG4gIGNvbnN0IGZpeHR1cmUgPSBUZXN0QmVkLmNyZWF0ZUNvbXBvbmVudChvcHRpb25zLmNvbXBvbmVudCk7XG4gIGNvbnN0IGRlYnVnRWxlbWVudCA9IGZpeHR1cmUuZGVidWdFbGVtZW50O1xuXG4gIGNvbnN0IGNvbXBvbmVudCA9IHNldFByb3BzKGZpeHR1cmUuY29tcG9uZW50SW5zdGFuY2UsIHByb3BzKTtcblxuICAvKipcbiAgICogQmFjayBjb21wYXRpYmlsaXR5LCBhbmd1bGFyIHVuZGVyIDkgdmVyc2lvbiBkb2VzbnQgaGF2ZSBhIGluamVjdCBmdW5jdGlvblxuICAgKi9cbiAgaWYgKCFUZXN0QmVkLmluamVjdCkge1xuICAgIHJldHVybiBuZXcgU3BlY3RhdG9yUm91dGluZyhmaXh0dXJlLCBkZWJ1Z0VsZW1lbnQsIGNvbXBvbmVudCwgVGVzdEJlZC5nZXQoUm91dGVyKSwgVGVzdEJlZC5nZXQoQWN0aXZhdGVkUm91dGUpKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgU3BlY3RhdG9yUm91dGluZyhcbiAgICBmaXh0dXJlLFxuICAgIGRlYnVnRWxlbWVudCxcbiAgICBjb21wb25lbnQsXG4gICAgVGVzdEJlZC5pbmplY3QoUm91dGVyKSxcbiAgICBUZXN0QmVkLmluamVjdChBY3RpdmF0ZWRSb3V0ZSkgYXMgU3B5T2JqZWN0PEFjdGl2YXRlZFJvdXRlU3R1Yj5cbiAgKTtcbn1cbiJdfQ==